<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng K√Ω Nh√¢n Vi√™n - Face Recognition System</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <h1>üéØ Face Recognition</h1>
            <div class="nav-links">
                <a href="/">Trang ch·ªß</a>
                <a href="/registration" class="active">ƒêƒÉng k√Ω</a>
                <a href="/recognition">Nh·∫≠n di·ªán</a>
                <a href="/employees">Nh√¢n vi√™n</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Hero -->
        <div class="hero">
            <h2>ƒêƒÉng K√Ω Nh√¢n Vi√™n M·ªõi</h2>
            <p>ƒêi·ªÅn th√¥ng tin v√† ch·ª•p 5 g√≥c khu√¥n m·∫∑t ƒë·ªÉ ƒëƒÉng k√Ω</p>
        </div>

        <!-- Registration Form -->
        <div class="system-info">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <!-- Left: Form -->
                <div>
                    <h3>Th√¥ng tin nh√¢n vi√™n</h3>
                    <form id="employeeForm">
                        <div class="form-group">
                            <label for="employee_id">M√£ nh√¢n vi√™n *</label>
                            <input type="text" id="employee_id" placeholder="VD: EPLE001" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="name">H·ªç v√† t√™n *</label>
                            <input type="text" id="name" placeholder="Nguy·ªÖn VƒÉn A" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="department">Ph√≤ng ban</label>
                            <input type="text" id="department" placeholder="IT">
                        </div>
                        
                        <div class="form-group">
                            <label for="position">Ch·ª©c v·ª•</label>
                            <input type="text" id="position" placeholder="Developer">
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" placeholder="example@company.com">
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%;">T·∫°o nh√¢n vi√™n</button>
                    </form>

                    <!-- Pose Capture Section (Hidden initially) -->
                    <div id="poseSection" style="display: none; margin-top: 30px;">
                        <h3>Ch·ª•p khu√¥n m·∫∑t (5 g√≥c)</h3>
                        <div id="poseProgress" style="margin-bottom: 20px;">
                            <div class="info-item">
                                <span class="label">üéØ Trung t√¢m</span>
                                <span class="value" id="pose-center">Ch·ªù...</span>
                            </div>
                            <div class="info-item">
                                <span class="label">‚¨ÖÔ∏è Quay tr√°i</span>
                                <span class="value" id="pose-left">Ch·ªù...</span>
                            </div>
                            <div class="info-item">
                                <span class="label">‚û°Ô∏è Quay ph·∫£i</span>
                                <span class="value" id="pose-right">Ch·ªù...</span>
                            </div>
                            <div class="info-item">
                                <span class="label">‚¨ÜÔ∏è Quay l√™n</span>
                                <span class="value" id="pose-up">Ch·ªù...</span>
                            </div>
                            <div class="info-item">
                                <span class="label">‚¨áÔ∏è Quay xu·ªëng</span>
                                <span class="value" id="pose-down">Ch·ªù...</span>
                            </div>
                        </div>

                        <div class="message info" id="poseGuidance">
                            H∆∞·ªõng khu√¥n m·∫∑t v·ªÅ trung t√¢m ƒë·ªÉ b·∫Øt ƒë·∫ßu
                        </div>

                        <button id="trainButton" class="btn btn-success" style="width: 100%; display: none;">
                            Hu·∫•n luy·ªán m√¥ h√¨nh
                        </button>
                    </div>
                </div>

                <!-- Right: Camera -->
                <div>
                    <h3>Camera</h3>
                    <div class="video-container">
                        <video id="video" autoplay playsinline></video>
                        <canvas id="canvas"></canvas>
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button id="switchCamera" class="btn btn-info" style="flex: 1;">
                            ƒê·ªïi camera
                        </button>
                        <button id="startCapture" class="btn btn-primary" style="flex: 1;" disabled>
                            B·∫Øt ƒë·∫ßu ch·ª•p
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/camera.js"></script>
    <script src="/static/js/api.js"></script>
    <script>
        const camera = new CameraManager();
        const api = new APIClient();
        
        let currentEmployeeId = null;
        let isCapturing = false;
        let captureInterval = null;
        
        const poses = ['center', 'left', 'right', 'up', 'down'];
        const poseNames = {
            'center': 'TH·∫≤NG',
            'left': 'TR√ÅI', 
            'right': 'PH·∫¢I',
            'up': 'TR√äN',
            'down': 'D∆Ø·ªöI'
        };
        let currentPoseIndex = 0;  // Start with first pose (center)
        const capturedPoses = new Set();
        const STABLE_FRAMES_REQUIRED = 30;
        let stableFrameCount = 0;
        let lastDetectedPose = null;

        // Camera will be initialized after employee creation

        // Employee form submission
        document.getElementById('employeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const employeeData = {
                employee_code: document.getElementById('employee_id').value,
                full_name: document.getElementById('name').value,
                department_id: null,
                position: document.getElementById('position').value || null,
                email: document.getElementById('email').value || null,
                phone_number: null
            };

            try {
                const result = await api.createEmployee(employeeData);
                currentEmployeeId = result.employee_code;
                
                // Initialize camera after employee created successfully
                await camera.init('video', 'canvas');
                
                alert('‚úÖ T·∫°o nh√¢n vi√™n th√†nh c√¥ng! B·∫Øt ƒë·∫ßu ch·ª•p ·∫£nh khu√¥n m·∫∑t.');
                document.getElementById('employeeForm').style.display = 'none';
                document.getElementById('poseSection').style.display = 'block';
                document.getElementById('startCapture').disabled = false;
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        });

        // Switch camera
        document.getElementById('switchCamera').addEventListener('click', () => {
            camera.switchCamera();
        });

        // Start capture
        document.getElementById('startCapture').addEventListener('click', () => {
            if (!isCapturing) {
                startPoseCapture();
            } else {
                stopPoseCapture();
            }
        });

        function startPoseCapture() {
            isCapturing = true;
            document.getElementById('startCapture').textContent = 'D·ª´ng ch·ª•p';
            document.getElementById('startCapture').classList.remove('btn-primary');
            document.getElementById('startCapture').classList.add('btn-danger');
            
            // Show instruction for current pose
            const currentPose = poses[currentPoseIndex];
            document.getElementById('poseGuidance').innerHTML = `<strong>üéØ H√£y quay ${poseNames[currentPose]}</strong>`;
            
            captureInterval = setInterval(async () => {
                const frame = camera.captureFrame();
                
                try {
                    const result = await api.detectHeadPose(frame);
                    const currentRequiredPose = poses[currentPoseIndex];
                    
                    // Only capture if detecting the REQUIRED pose
                    if (result.current_pose === currentRequiredPose && !capturedPoses.has(currentRequiredPose)) {
                        // Check if pose is stable
                        if (lastDetectedPose === result.current_pose) {
                            stableFrameCount++;
                            
                            // Update progress
                            const progress = Math.round((stableFrameCount / STABLE_FRAMES_REQUIRED) * 100);
                            document.getElementById(`pose-${result.current_pose}`).textContent = `${progress}%`;
                            document.getElementById('poseGuidance').innerHTML = `<strong>‚úÖ Gi·ªØ nguy√™n! ${progress}%</strong>`;
                            
                            if (stableFrameCount >= STABLE_FRAMES_REQUIRED) {
                                // Capture this pose
                                await capturePose(result.current_pose, frame);
                                stableFrameCount = 0;
                                lastDetectedPose = null;
                                
                                // Move to next pose
                                currentPoseIndex++;
                                if (currentPoseIndex < poses.length) {
                                    const nextPose = poses[currentPoseIndex];
                                    document.getElementById('poseGuidance').innerHTML = `<strong>üéØ H√£y quay ${poseNames[nextPose]}</strong>`;
                                }
                            }
                        } else {
                            // Pose changed or just started detecting
                            stableFrameCount = 0;
                            lastDetectedPose = result.current_pose;
                        }
                    } else if (result.current_pose !== currentRequiredPose) {
                        // Wrong pose, show guidance
                        stableFrameCount = 0;
                        lastDetectedPose = null;
                        document.getElementById('poseGuidance').innerHTML = `<strong>üéØ H√£y quay ${poseNames[currentRequiredPose]}</strong> (ƒêang: ${result.message})`;
                    }
                } catch (error) {
                    console.error('Pose detection error:', error);
                }
            }, 100); // 10 FPS
        }

        function stopPoseCapture() {
            isCapturing = false;
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }
            
            document.getElementById('startCapture').textContent = 'B·∫Øt ƒë·∫ßu ch·ª•p';
            document.getElementById('startCapture').classList.remove('btn-danger');
            document.getElementById('startCapture').classList.add('btn-primary');
        }

        async function capturePose(pose, frame) {
            try {
                await api.registerFace(currentEmployeeId, frame, pose);
                
                capturedPoses.add(pose);
                document.getElementById(`pose-${pose}`).innerHTML = '<span class="status-online">‚úì Ho√†n th√†nh</span>';
                
                // Check if all poses captured
                if (capturedPoses.size === 5) {
                    stopPoseCapture();
                    document.getElementById('poseGuidance').innerHTML = '<span class="status-online">‚úÖ ƒê√£ ch·ª•p ƒë·ªß 5 g√≥c! B·∫°n c√≥ th·ªÉ hu·∫•n luy·ªán m√¥ h√¨nh.</span>';
                    document.getElementById('trainButton').style.display = 'block';
                }
            } catch (error) {
                alert('‚ùå L·ªói khi l∆∞u ·∫£nh: ' + error.message);
            }
        }

        // Train model
        document.getElementById('trainButton').addEventListener('click', async () => {
            try {
                document.getElementById('trainButton').disabled = true;
                document.getElementById('trainButton').textContent = 'ƒêang hu·∫•n luy·ªán...';
                
                await api.trainModel(currentEmployeeId);
                
                alert('‚úÖ Hu·∫•n luy·ªán m√¥ h√¨nh th√†nh c√¥ng!');
                window.location.href = '/employees';
            } catch (error) {
                alert('‚ùå L·ªói khi hu·∫•n luy·ªán: ' + error.message);
                document.getElementById('trainButton').disabled = false;
                document.getElementById('trainButton').textContent = 'Hu·∫•n luy·ªán m√¥ h√¨nh';
            }
        });
    </script>
</body>
</html>
